package com.example.azure_sql_demo.config;

import org.flywaydb.core.Flyway;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;

import jakarta.annotation.PostConstruct;
import javax.sql.DataSource;

@Configuration
@Profile("docker") // Apenas para perfil docker (SQL Server)
public class FlywayMigrationConfig {

    @Autowired
    private DataSource dataSource;

    @PostConstruct
    public void migrateFlyway() {
        try {
            System.out.println("üöÄ Iniciando migra√ß√µes Flyway para SQL Server...");
            
            Flyway flyway = Flyway.configure()
                .dataSource(dataSource)
                .locations("classpath:db/migration")
                .baselineOnMigrate(true)
                .validateOnMigrate(true)
                .outOfOrder(false)
                .cleanDisabled(false)
                .load();

            // Informa√ß√µes sobre migra√ß√µes
            var info = flyway.info();
            System.out.println("üìä Status das migra√ß√µes:");
            for (var migration : info.all()) {
                System.out.println("  - " + migration.getVersion() + ": " + migration.getDescription() + " [" + migration.getState() + "]");
            }

            // Executar migra√ß√µes
            var result = flyway.migrate();
            System.out.println("‚úÖ Flyway executado com sucesso! " + result.migrationsExecuted + " migra√ß√µes aplicadas.");
            
            // Mostrar migra√ß√µes aplicadas
            if (result.migrationsExecuted > 0) {
                System.out.println("üìã Migra√ß√µes aplicadas:");
                for (var output : result.warnings) {
                    System.out.println("  ‚ö†Ô∏è " + output);
                }
            }
            
        } catch (Exception e) {
            System.err.println("‚ùå Erro no Flyway: " + e.getMessage());
            e.printStackTrace();
            throw new RuntimeException("Falha na migra√ß√£o do banco de dados", e);
        }
    }
}